plugins {
    id "java"
    id "org.springframework.boot" version '2.1.6.RELEASE'
    id "io.spring.dependency-management" version "1.0.7.RELEASE"
    id "com.bmuschko.docker-remote-api" version "4.6.2"
}

group = 'io.maslick'
version = '0.0.1-SNAPSHOT'
sourceCompatibility = '11'

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

import com.bmuschko.gradle.docker.tasks.image.Dockerfile
task createDockerfile(type: Dockerfile) {
    destFile = project.file('build/libs/Dockerfile')
    from 'maslick/minimalka:jdk11'
    instruction 'LABEL maintainer="pavel.masloff@gmail.com"'
    exposePort 8080
    workingDir '/app'
    copyFile jar.archiveFileName.get(), './app.jar'
    instruction 'CMD java $JAVA_OPTIONS -jar app.jar'
}

check.dependsOn createDockerfile

task dockerBuild(type: Exec) {
    commandLine 'docker', 'build', '-t', "minimalka-boot", 'build/libs'
    dependsOn build
    test.enabled = false
}